import javax.swing.*;
import java.awt.*;
import java.awt.event.*;
import java.sql.*;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;

public class BillingSystem {

    static int grandTotal = 0;

    public static void main(String[] args) {

        DBConnection.connect();

        JFrame frame = new JFrame("Automatic Billing System");
        frame.setSize(800, 600);
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.setLayout(new BorderLayout(10, 10));

        // ===== COLORS =====
        Color bgColor = new Color(230, 240, 255);
        Color panelColor = new Color(255, 255, 255);
        Color primaryColor = new Color(41, 128, 185);
        Color accentColor = new Color(39, 174, 96);
        Color dangerColor = new Color(231, 76, 60);
        Color textColor = new Color(33, 33, 33);

        frame.getContentPane().setBackground(bgColor);

        // ===== TITLE =====
        JLabel title = new JLabel("Automatic Billing System", SwingConstants.CENTER);
        title.setFont(new Font("Segoe UI", Font.BOLD, 24));
        title.setForeground(primaryColor);
        title.setBorder(BorderFactory.createEmptyBorder(15,10,15,10));
        frame.add(title, BorderLayout.NORTH);

        // ===== MAIN PANEL =====
        JPanel mainPanel = new JPanel(new BorderLayout(10,10));
        mainPanel.setBackground(bgColor);

        // ===== CLOCK =====
        JLabel clockLabel = new JLabel();
        clockLabel.setHorizontalAlignment(SwingConstants.RIGHT);
        clockLabel.setFont(new Font("Segoe UI", Font.BOLD, 14));
        clockLabel.setForeground(primaryColor);

        // ===== FORM PANEL =====
        JPanel formPanel = new JPanel(new GridBagLayout());
        formPanel.setBackground(panelColor);
        formPanel.setBorder(BorderFactory.createEmptyBorder(15,15,15,15));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(8, 8, 8, 8);
        gbc.fill = GridBagConstraints.HORIZONTAL;

        Font labelFont = new Font("Segoe UI", Font.BOLD, 14);
        Font fieldFont = new Font("Segoe UI", Font.PLAIN, 13);

        JLabel nameLabel = new JLabel("Customer Name:");
        nameLabel.setFont(labelFont);
        nameLabel.setForeground(textColor);
        JTextField nameField = new JTextField(15);
        nameField.setFont(fieldFont);

        JLabel itemLabel = new JLabel("Select Item:");
        itemLabel.setFont(labelFont);
        itemLabel.setForeground(textColor);
        JComboBox<String> itemBox = new JComboBox<>(new String[]{"Rice", "Sugar", "Milk"});
        itemBox.setFont(fieldFont);

        JLabel qtyLabel = new JLabel("Quantity:");
        qtyLabel.setFont(labelFont);
        qtyLabel.setForeground(textColor);
        JTextField qtyField = new JTextField(10);
        qtyField.setFont(fieldFont);

        JButton addBtn = new JButton("Add Item");
        JButton billBtn = new JButton("Generate Bill");

        addBtn.setBackground(primaryColor);
        billBtn.setBackground(accentColor);

        addBtn.setForeground(Color.WHITE);
        billBtn.setForeground(Color.WHITE);

        addBtn.setBorder(BorderFactory.createEmptyBorder(8,15,8,15));
        billBtn.setBorder(BorderFactory.createEmptyBorder(8,15,8,15));

        // Layout
        gbc.gridx=0; gbc.gridy=0;
        formPanel.add(nameLabel, gbc);
        gbc.gridx=1;
        formPanel.add(nameField, gbc);

        gbc.gridx=0; gbc.gridy=1;
        formPanel.add(itemLabel, gbc);
        gbc.gridx=1;
        formPanel.add(itemBox, gbc);

        gbc.gridx=0; gbc.gridy=2;
        formPanel.add(qtyLabel, gbc);
        gbc.gridx=1;
        formPanel.add(qtyField, gbc);

        gbc.gridx=0; gbc.gridy=3;
        formPanel.add(addBtn, gbc);
        gbc.gridx=1;
        formPanel.add(billBtn, gbc);

        JPanel topPanel = new JPanel(new BorderLayout());
        topPanel.setBackground(bgColor);
        topPanel.add(clockLabel, BorderLayout.NORTH);
        topPanel.add(formPanel, BorderLayout.CENTER);

        // ===== BILL AREA =====
        JTextArea billArea = new JTextArea();
        billArea.setEditable(false);
        billArea.setFont(new Font("Consolas", Font.PLAIN, 13));
        billArea.setText("Item\tQty\tPrice\tTotal\n");
        JScrollPane scrollPane = new JScrollPane(billArea);

        // ===== BOTTOM PANEL =====
        JPanel bottomPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        bottomPanel.setBackground(panelColor);

        JLabel totalLabel = new JLabel("Grand Total:");
        totalLabel.setFont(labelFont);
        totalLabel.setForeground(textColor);

        JTextField totalField = new JTextField("0", 10);
        totalField.setEditable(false);
        totalField.setFont(fieldFont);

        JButton viewBtn = new JButton("View Bills");
        JButton clearBtn = new JButton("Clear");

        viewBtn.setBackground(primaryColor);
        clearBtn.setBackground(dangerColor);

        viewBtn.setForeground(Color.WHITE);
        clearBtn.setForeground(Color.WHITE);

        viewBtn.setBorder(BorderFactory.createEmptyBorder(8,15,8,15));
        clearBtn.setBorder(BorderFactory.createEmptyBorder(8,15,8,15));

        bottomPanel.add(totalLabel);
        bottomPanel.add(totalField);
        bottomPanel.add(viewBtn);
        bottomPanel.add(clearBtn);

        mainPanel.add(topPanel, BorderLayout.NORTH);
        mainPanel.add(scrollPane, BorderLayout.CENTER);
        mainPanel.add(bottomPanel, BorderLayout.SOUTH);

        frame.add(mainPanel, BorderLayout.CENTER);

        // ===== ADD ITEM =====
        ActionListener addItemLogic = e -> {

            if (qtyField.getText().isEmpty()) {
                JOptionPane.showMessageDialog(frame, "Enter quantity");
                return;
            }

            int qty;
            try {
                qty = Integer.parseInt(qtyField.getText());
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(frame, "Enter valid number");
                return;
            }

            String item = (String) itemBox.getSelectedItem();
            int price = 0;

            if (item.equals("Rice")) price = 60;
            else if (item.equals("Sugar")) price = 45;
            else if (item.equals("Milk")) price = 30;

            int total = price * qty;
            grandTotal += total;

            billArea.append(item + "\t" + qty + "\t" + price + "\t" + total + "\n");
            totalField.setText(String.valueOf(grandTotal));
            qtyField.setText("");
        };

        addBtn.addActionListener(addItemLogic);
        qtyField.addActionListener(addItemLogic);

        // ===== GENERATE BILL =====
        billBtn.addActionListener(e -> {

            String customerName = nameField.getText().trim();

            if (customerName.isEmpty()) {
                JOptionPane.showMessageDialog(frame, "Enter customer name!");
                return;
            }

            if (grandTotal <= 0) {
                JOptionPane.showMessageDialog(frame, "No items added!");
                return;
            }

            saveBill(customerName, grandTotal);

            JOptionPane.showMessageDialog(frame,
                    "Customer: " + customerName +
                    "\nTotal: Rs. " + grandTotal +
                    "\n\nThank you!",
                    "Bill Generated",
                    JOptionPane.INFORMATION_MESSAGE);
        });

        viewBtn.addActionListener(e -> viewBills());
        clearBtn.addActionListener(e -> {
            billArea.setText("Item\tQty\tPrice\tTotal\n");
            totalField.setText("0");
            grandTotal = 0;
        });

        // ===== CLOCK THREAD =====
        Thread clockThread = new Thread(() -> {
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("HH:mm:ss");
            while (true) {
                clockLabel.setText("Time: " + LocalTime.now().format(formatter));
                try { Thread.sleep(1000); } catch (Exception ignored) {}
            }
        });
        clockThread.start();

        frame.setVisible(true);
    }

    public static void saveBill(String name, int total) {
        try {
            Connection con = DriverManager.getConnection("jdbc:sqlite:billing.db");
            String sql = "INSERT INTO bills(customer_name, total_amount) VALUES(?, ?)";
            PreparedStatement ps = con.prepareStatement(sql);
            ps.setString(1, name);
            ps.setInt(2, total);
            ps.executeUpdate();
            ps.close();
            con.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static void viewBills() {

        JFrame viewFrame = new JFrame("Saved Bills");
        viewFrame.setSize(450, 400);

        JTextArea area = new JTextArea();
        area.setEditable(false);

        try {
            Connection con = DriverManager.getConnection("jdbc:sqlite:billing.db");
            Statement stmt = con.createStatement();
            ResultSet rs = stmt.executeQuery("SELECT * FROM bills");

            area.append("ID\tCustomer\tTotal\n");
            area.append("----------------------------------\n");

            while (rs.next()) {
                area.append(
                        rs.getInt("id") + "\t" +
                        rs.getString("customer_name") + "\tRs." +
                        rs.getInt("total_amount") + "\n"
                );
            }

            rs.close();
            stmt.close();
            con.close();

        } catch (Exception e) {
            e.printStackTrace();
        }

        viewFrame.add(new JScrollPane(area));
        viewFrame.setVisible(true);
    }
}
